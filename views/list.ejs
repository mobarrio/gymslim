<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GYMSLIM - Horario de Clases</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body { padding-top: 70px; } /* Espacio para el nav fijo */
        .clase-favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            color: #ccc;
            font-size: 1.2em;
            transition: color 0.2s, transform 0.2s;
            vertical-align: middle;
        }
        .clase-favorite-btn:hover {
            transform: scale(1.1);
        }
        .clase-favorite-btn.active {
            color: #ff9800; /* Color naranja para favorito activo */
        }
        .clase-favorite-btn.active:hover {
            color: #d68900;
        }
        .clase-info {
            display: flex;
            align-items: center;
            justify-content: space-between; /* Espacio para el botón de favorito */
        }
        .clase-details-group {
            display: flex;
            align-items: center;
        }
        .filter-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap; /* Permite que los controles se ajusten en móvil */
        }
        
        /* Estilo de texto para estados no reservables */
        .closed-text, .soldout-text {
            font-weight: 600;
            color: #dc3545; /* Rojo base */
            font-size: 13px;
        }
        
        /* --- ESTILOS CRÍTICOS DE FILA (Non-Bookable) --- */
        .non-bookable-row {
            background-color: rgb(255, 133, 104, 0.5) !important; 
            opacity: 0.95;
            color: #555;
        }
        .non-bookable-row:hover {
            background-color: rgb(255, 133, 104, 0.7) !important;
        }
        /* Estilo para el Checkbox de Cerradas */
        #closedFilterForm label {
            font-weight: normal;
            margin-left: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <%- include('./partials/_nav') %>

    <!-- Modales y Notificaciones (Simplificados) -->
    <div id="imageModal"></div>
    <div id="notification-toast" class="hidden"> <span id="notification-message"></span> </div>

    <div class="container">
        <h2>Clases de <%= startDate %> a <%= endDate %></h2>

        <div class="filter-controls">
            
            <!-- Selector 1: Filtro por Actividad -->
            <form id="activityFilterForm" action="/list" method="GET">
                <label for="activity_filter">Filtrar por Actividad:</label>
                <select id="activity_filter" name="activity" onchange="this.form.submit()">
                    <option value="todas" <%= selectedActivity === 'todas' ? 'selected' : '' %>>Todas</option>
                    <% allActivityNames.forEach(name => { %>
                        <option value="<%= name %>" <%= selectedActivity === name ? 'selected' : '' %>>
                            <%= name %>
                        </option>
                    <% }) %>
                </select>
                <!-- Mantener parámetros de fecha, filtro de favoritos y filtro de cerradas -->
                <input type="hidden" name="start" value="<%= startDate %>">
                <input type="hidden" name="end" value="<%= endDate %>">
                <input type="hidden" name="filter" value="<%= currentFilter %>">
                <!-- IMPORTANTISIMO: mantener el estado del checkbox -->
                <input type="hidden" name="showClosed" value="<%= showClosedState ? 'true' : 'false' %>">
            </form>

            <!-- Selector 2: Filtro Favoritas -->
            <form id="favoriteFilterForm" action="/list" method="GET">
                <label for="filter_type">Mostrar Clases:</label>
                <select id="filter_type" name="filter" onchange="this.form.submit()">
                    <option value="all" <%= currentFilter === 'all' ? 'selected' : '' %>>Todas las clases</option>
                    <option value="favorites" <%= currentFilter === 'favorites' ? 'selected' : '' %>>Mis Favoritas</option>
                </select>
                <!-- Mantener parámetros de fecha, actividad y filtro de cerradas -->
                <input type="hidden" name="start" value="<%= startDate %>">
                <input type="hidden" name="end" value="<%= endDate %>">
                <input type="hidden" name="activity" value="<%= selectedActivity %>">
                <input type="hidden" name="showClosed" value="<%= showClosedState ? 'true' : 'false' %>">
            </form>

            <!-- Selector 3: Checkbox Mostrar Cerradas (NUEVO) -->
            <form id="closedFilterForm" action="/list" method="GET">
                <input type="checkbox" 
                       id="showClosed" 
                       name="showClosed" 
                       value="true" 
                       onchange="this.form.submit()"
                       <%= showClosedState ? 'checked' : '' %>>
                <label for="showClosed">Mostrar clases no reservables</label>
                
                <!-- Mantener parámetros de contexto -->
                <input type="hidden" name="start" value="<%= startDate %>">
                <input type="hidden" name="end" value="<%= endDate %>">
                <input type="hidden" name="activity" value="<%= selectedActivity %>">
                <input type="hidden" name="filter" value="<%= currentFilter %>"> 
            </form>
        </div>


        <% if (!events || events.length === 0) { %>
            <hr>
            <p>
                <% if (currentFilter === 'favorites' && favoriteNames.length === 0) { %>
                    No has marcado ninguna actividad como favorita.
                <% } else if (currentFilter === 'favorites' && events.length === 0) { %>
                    No hay clases favoritas programadas en este rango de fechas.
                <% } else if (startDate === endDate) { %>
                    No hay más clases programadas para hoy (<%= startDate %>).
                <% } else { %>
                    No hay clases futuras programadas entre <%= startDate %> y <%= endDate %>.
                <% } %>
            </p>
        <% } else { %>
            <!-- Tabla de Clases -->
            <table>
                <tr>
                    <th class="col-clase">Clase</th>
                    <th class="col-fecha">Fecha</th>
                    <th class="col-plazas">Plazas</th>
                    <th class="col-sesion">Sesión</th>
                </tr>

                <% events.forEach(event => { %>
                    <%
                        const instructor = helpers.obtenerInstructor(event);
                        const avatar = helpers.obtenerAvatar(event);
                        const places = event.booking_info.places;
                        const bookingInfo = event.booking_info || {};
                        
                        // --- LÓGICA DE RESERVA (Versión Papa - REGLAS DE VISUALIZACIÓN) ---
                        const isSoldOut = bookingInfo.sold_out === true;
                        const isTooLate = bookingInfo.too_late === true;
                        const isTooSoon = bookingInfo.too_soon === true;
                        const isAvailableFalse = bookingInfo.available === false;
                        
                        let rowClass = '';
                        let sessionText = '';
                        let isBookable = true;

                        if (isSoldOut) {
                            rowClass = 'non-bookable-row';
                            sessionText = 'SIN PLAZAS';
                            isBookable = false;
                        } else if (isTooLate || isTooSoon || isAvailableFalse) {
                            // Esta es la regla compleja para CLASE CERRADA
                            rowClass = 'non-bookable-row';
                            sessionText = 'CLASE CERRADA';
                            isBookable = false;
                        }
                        
                        const plazasDisplay = helpers.formatearPlazas(places);
                        const fecha = helpers.formatearFecha(event.mobile);
                        const id = event.session_id;
                        const roomName = event.room || 'N/A';
                        const activityName = event.activity_name || '';

                        const isFavorite = favoriteNames.includes(activityName);
                    %>
                    <!-- Aplica la clase condicionalmente a la fila -->
                    <tr class="<%= rowClass %>">
                        <td>
                            <div class="clase-info">
                                <div class="clase-details-group">
                                    <img src="<%= avatar %>" class="clase-avatar zoomable-avatar" alt="Avatar">
                                    <div class="clase-details">
                                        <span class="clase-title"><%= event.title || 'N/A' %></span>
                                        <span class="clase-subtitle">
                                            <%= roomName %> 
                                            <%= (instructor && instructor !== 'Gimnasio' && instructor !== 'N/A') ? '- ' + instructor : '' %>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Botón de Favorito -->
                                <button class="clase-favorite-btn <%= isFavorite ? 'active' : '' %>"
                                        data-activity="<%= activityName %>"
                                        data-action="<%= isFavorite ? 'remove' : 'add' %>"
                                        title="<%= isFavorite ? 'Quitar de Favoritas' : 'Añadir a Favoritas' %>">
                                    <!-- Icono de Corazón SVG -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="<%= isFavorite ? 'currentColor' : 'none' %>" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                                </button>
                                
                            </div>
                        </td>
                        <td><%= fecha %></td>
                        <td><%= plazasDisplay %></td>
                        <td>
                            <% if (isBookable) { %>
                                <!-- Disponible para Reservar -->
                                <button class="sesion-link btn-reservar" 
                                        data-session-id="<%= id %>" 
                                        data-room-name="<%= roomName %>">
                                    Reservar <%= id %>
                                </button>
                            <% } else { %>
                                <!-- Muestra el estado de cierre/agotado -->
                                <span class="<%= isSoldOut ? 'soldout-text' : 'closed-text' %>">
                                    <%= sessionText %>
                                </span>
                            <% } %>
                        </td>
                    </tr>
                <% }) %>
            </table>
        <% } %>
    </div>

    <!-- El script main.js ahora contiene la lógica para los botones de favoritos -->
    <script src="/js/main.js"></script>
</body>
</html>
